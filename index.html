<html>

  <head>
    <meta http-equiv="Content-Type" content="text/html;">
    <title>Differential</title>
    <script type="text/javascript" src="js/difflib.js"></script>
    <script type="text/javascript" src="js/diffview.js"></script>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="css/diffview.css">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    
    <script language="javascript">
      $(function() {
        // get files to compare: #baseText.json,newText.json
        var hash = window.location.hash.substr(1);
        var files = hash.split(',');
        
        // set default
        if(!window.location.hash.length) {
          files = Array('baseText.json', 'newText.json');
          window.location.hash = 'baseText.json,newText.json';
        }
        
        // change endpoint here
        //var endpoint = 'https://api.cmc.appirio.net/va1/metadata/';
        var endpoint = 'http://soe.github.com/differential/files/';
        
        // data/params to pass while getting from the endpoint
        var data = {'param1': 'value1'};
        
        var baseText, newText;
        
        // ajax-ception!!!
        $.ajax({ // get baseText
          url: endpoint + files[0],
          dataType: 'json',
          data: data,
          success: function(data) {
            baseText = data;
            console.log(data);
          },
          complete: function() {
            $.ajax({ // get newText
              url: endpoint + files[1],
              dataType: 'json',
              data: data,
              success: function(data) { 
                newText = data;
                console.log(data);
              },
              complete: function() { // now doDiff
                doDiff(baseText, newText);
              }
            });
          }
        }); // end ajax-ception!!!
        
        var doDiff = function(baseText, newText){
        	var baseTextLines = difflib.stringAsLines(baseText['source']);
        	var newTextLines = difflib.stringAsLines(newText['source']);
        	
        	// difflib.SequenceMatcher
        	var startTime = (new Date()).getTime();
        	var sm = new difflib.SequenceMatcher(baseTextLines, newTextLines);
        	var opcodes = sm.get_opcodes();
          var endTime = (new Date()).getTime();
          console.log('difflib.SequenceMatcher: ' + (endTime - startTime) + ' ms');
          
        	var $diff_output = $("#diff-output");
        	$diff_output.html('');
        	
        	// render diff side-by-side
        	var startTime = (new Date()).getTime();
          	$diff_output.html(
              diffview.buildView({ 
              baseTextLines:baseTextLines,
              newTextLines:newTextLines,
              opcodes:opcodes,
              baseTextName:baseText['name'],
              newTextName:newText['name'],
              contextSize:0,
              viewType:0
          	})
        	);
        	var endTime = (new Date()).getTime();
          console.log('diffview.buildView: ' + (endTime - startTime) + ' ms');
        }; // end doDiff function
      });
    </script>
</head>
<body>
  <div id="container">
    <div id="header">
      <div id="logo">Differential <i>- Javascript Diff UI component</i></div>
      <div id="links">
        <a href="https://bit.ly/differential-demo" target="_blank">Demo</a>
        <a href="https://bit.ly/differential-code" target="_blank">Code</a>
        <a href="https://bit.ly/differential-doc" target="_blank">Documentation</a>
      </div>
    </div>
    <br />
    <hr />
  	<div id="diff-output" style="width:100%">
  	  <!-- diff output -->
  	</div>
  </div>
</body></html>