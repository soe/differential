<html>

  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title>Differential</title>
    <script type="text/javascript" src="js/difflib.js"></script>
    <script type="text/javascript" src="js/diffview.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    
    <link rel="stylesheet" type="text/css" href="css/diffview.css">
    
    <script language="javascript">
      $(function() {
        // get files to compare: #baseText.json,newText.json
        var hash = window.location.hash.substr(1);
        var files = hash.split(',');
        
        //var endpoint = 'https://api.cmc.appirio.net/va1/metadata/';
        var endpoint = 'http://soe.github.com/differential/files/';
        
        // data/params to pass while getting from the endpoint
        var data = {'param1': 'value1'};
        
        var baseText, newText;
        
        // ajax-ception!!!
        $.ajax({ // get baseText
          url: endpoint + files[0],
          dataType: 'json',
          data: data,
          success: function(data) {
            baseText = data;
            console.log(data);
          },
          complete: function() {
            $.ajax({ // get newText
              url: endpoint + files[1],
              dataType: 'json',
              data: data,
              success: function(data) { 
                newText = data;
                console.log(data);
              },
              complete: function() {
                doDiff(baseText, newText);
              }
            });
          }
        });
        
        var doDiff = function(baseText, newText){
        	var baseTextLines = difflib.stringAsLines(baseText['source']);
        	var newTextLines = difflib.stringAsLines(newText['source']);
        	
        	// difflib.SequenceMatcher
        	var startTime = (new Date()).getTime();
        	var sm = new difflib.SequenceMatcher(baseTextLines, newTextLines);
        	var opcodes = sm.get_opcodes();
          var endTime = (new Date()).getTime();
          console.log('difflib.SequenceMatcher: ' + (endTime - startTime) + ' ms');
          
        	var $diffoutput = $("#diffoutput");
        	$diffoutput.html('');
        	
        	// render diff side-by-side
        	var startTime = (new Date()).getTime();
          	$diffoutput.html(
              diffview.buildView({ 
              baseTextLines:baseTextLines,
              newTextLines:newTextLines,
              opcodes:opcodes,
              baseTextName:baseText['name'],
              newTextName:newText['name'],
              contextSize:0,
              viewType:0
          	})
        	);
        	var endTime = (new Date()).getTime();
          console.log('diffview.buildView: ' + (endTime - startTime) + ' ms');
        };
        
        // when diff button is clicked
        $("#diff").click(doDiff());
      });
    </script>
</head>
<body>
  <input type="button" id="diff" value="diff" />
  <table width="840px">
    <tr>
      <td><textarea id="baseText" style="width:400px;height:10px"></textarea></td>
      <td><textarea id="newText" style="width:400px;height:10px"></textarea></td>
    </tr>
  </table>
	<div id="diffoutput" style="width:100%"> </div>
</body></html>